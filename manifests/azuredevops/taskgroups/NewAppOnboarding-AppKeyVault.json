{
	"category": "Deploy",
	"description": "Provision a key vault for an app",
	"friendlyName": "NewAppOnboarding - Provision App Key Vault",
	"iconUrl": "https://cdn.vsassets.io/v/M147_20190228.6/_content/icon-meta-task.png",
	"inputs": [
		{
			"aliases": [],
			"options": {},
			"properties": {},
			"name": "appenvironment",
			"label": "appenvironment",
			"defaultValue": "",
			"required": true,
			"type": "string",
			"helpMarkDown": "",
			"groupName": ""
		},
		{
			"aliases": [],
			"options": {},
			"properties": {},
			"name": "appname",
			"label": "appname",
			"defaultValue": "",
			"required": true,
			"type": "string",
			"helpMarkDown": "",
			"groupName": ""
		},
		{
			"aliases": [],
			"options": {},
			"properties": {
				"EditableOptions": "True"
			},
			"name": "Azure_DataResourceGroup",
			"label": "Azure_DataResourceGroup",
			"defaultValue": "",
			"required": true,
			"type": "pickList",
			"helpMarkDown": "Provide the name of a resource group.",
			"groupName": ""
		},
		{
			"aliases": [],
			"options": {},
			"properties": {
				"EditableOptions": "True"
			},
			"name": "Azure_DataResourceGroup_Region",
			"label": "Azure_DataResourceGroup_Region",
			"defaultValue": "",
			"required": true,
			"type": "pickList",
			"helpMarkDown": "Location for deploying the resource group. If the resource group already exists in the subscription, then this value will be ignored.",
			"groupName": ""
		},
		{
			"aliases": [],
			"options": {},
			"properties": {
				"EndpointFilterRule": "ScopeLevel != ManagementGroup"
			},
			"name": "Azure_Subcription",
			"label": "Azure_Subcription",
			"defaultValue": "",
			"required": true,
			"type": "connectedService:AzureRM",
			"helpMarkDown": "Select the Azure Resource Manager subscription for the deployment.",
			"groupName": ""
		}
	],
	"instanceNameFormat": "Task group: NewAppOnboarding - Provision App Key Vault - Copy $(appenvironment)",
	"name": "NewAppOnboarding - Provision App Key Vault - Copy",
	"parentDefinitionId": null,
	"runsOn": [
		"Agent",
		"DeploymentGroup"
	],
	"tasks": [
		{
			"alwaysRun": false,
			"condition": "succeeded()",
			"continueOnError": false,
			"displayName": "Get Azure Tenant ID and Service Principal Object ID",
			"enabled": true,
			"inputs": {
				"connectedServiceNameARM": "$(Azure_Subcription)",
				"scriptLocation": "inlineScript",
				"scriptPath": "",
				"inlineScript": "TENANTID=`az account get-access-token --query tenant --output tsv`\nSPOBJECTID=`az ad sp show --id $servicePrincipalId --query objectId --output tsv`\necho \"##vso[task.setvariable variable=aztenantid]$TENANTID\"\necho \"##vso[task.setvariable variable=serviceprincipalobjectid]$SPOBJECTID\"\n",
				"args": "",
				"addSpnToEnvironment": "true",
				"useGlobalConfig": "false",
				"cwd": "",
				"failOnStandardError": "false"
			},
			"task": {
				"id": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
				"definitionType": "task",
				"versionSpec": "1.*"
			},
			"timeoutInMinutes": 0,
			"environment": {}
		},
		{
			"alwaysRun": false,
			"condition": "succeeded()",
			"continueOnError": false,
			"displayName": "Replace tokens in $(System.DefaultWorkingDirectory)/manifests/azure/appkeyvault/*.json",
			"enabled": true,
			"inputs": {
				"rootDirectory": "",
				"targetFiles": "$(System.DefaultWorkingDirectory)/manifests/azure/appkeyvault/*.json",
				"encoding": "auto",
				"writeBOM": "true",
				"verbosity": "normal",
				"actionOnMissing": "warn",
				"keepToken": "false",
				"tokenPrefix": "#{",
				"tokenSuffix": "}#",
				"emptyValue": "(empty)",
				"escapeType": "none",
				"escapeChar": "",
				"charsToEscape": ""
			},
			"task": {
				"id": "a8515ec8-7254-4ffd-912c-86772e2b5962",
				"definitionType": "task",
				"versionSpec": "3.*"
			},
			"timeoutInMinutes": 0,
			"environment": {}
		},
		{
			"alwaysRun": false,
			"condition": "succeeded()",
			"continueOnError": false,
			"displayName": "echo",
			"enabled": true,
			"inputs": {
				"script": "cat $(System.DefaultWorkingDirectory)/manifests/azure/appkeyvault/parameters.json",
				"workingDirectory": "",
				"failOnStderr": "false"
			},
			"task": {
				"id": "d9bafed4-0b18-4f58-968d-86655b4d2ce9",
				"definitionType": "task",
				"versionSpec": "2.*"
			},
			"timeoutInMinutes": 0,
			"environment": {}
		},
		{
			"alwaysRun": false,
			"condition": "succeeded()",
			"continueOnError": false,
			"displayName": "Deploy Key Vault",
			"enabled": true,
			"inputs": {
				"ConnectedServiceName": "$(Azure_Subcription)",
				"action": "Create Or Update Resource Group",
				"resourceGroupName": "$(Azure_DataResourceGroup)",
				"location": "$(Azure_DataResourceGroup_Region)",
				"templateLocation": "Linked artifact",
				"csmFileLink": "",
				"csmParametersFileLink": "",
				"csmFile": "$(System.DefaultWorkingDirectory)/manifests/azure/appkeyvault/template.json",
				"csmParametersFile": "$(System.DefaultWorkingDirectory)/manifests/azure/appkeyvault/parameters.json",
				"overrideParameters": "",
				"deploymentMode": "Incremental",
				"enableDeploymentPrerequisites": "None",
				"deploymentGroupEndpoint": "",
				"project": "",
				"deploymentGroupName": "",
				"copyAzureVMTags": "true",
				"runAgentServiceAsUser": "false",
				"userName": "",
				"password": "",
				"outputVariable": "",
				"deploymentName": "",
				"deploymentOutputs": "",
				"addSpnToEnvironment": "false"
			},
			"task": {
				"id": "94a74903-f93f-4075-884f-dc11f34058b4",
				"definitionType": "task",
				"versionSpec": "2.*"
			},
			"timeoutInMinutes": 0,
			"environment": {}
		},
		{
			"alwaysRun": false,
			"condition": "succeeded()",
			"continueOnError": false,
			"displayName": "Create Mendix Administration Password",
			"enabled": true,
			"inputs": {
				"ConnectedServiceName": "$(Azure_Subcription)",
				"KeyVaultName": "kvmx-$(appname)-$(appenvironment)",
				"SecretName": "$(appenvironment)-mxadminpassword",
				"SecretValue": "",
				"KeepValue": "true",
				"SecretLength": "30",
				"ExcludeSpecialChars": "false"
			},
			"task": {
				"id": "2fcdbd16-2baa-491d-9ed9-2923060a54be",
				"definitionType": "task",
				"versionSpec": "1.*"
			},
			"timeoutInMinutes": 0,
			"environment": {}
		},
		{
			"alwaysRun": false,
			"condition": "succeeded()",
			"continueOnError": false,
			"displayName": "Create Mendix Debugger Password",
			"enabled": true,
			"inputs": {
				"ConnectedServiceName": "$(Azure_Subcription)",
				"KeyVaultName": "kvmx-$(appname)-$(appenvironment)",
				"SecretName": "$(appenvironment)-mxdebugpassword",
				"SecretValue": "",
				"KeepValue": "true",
				"SecretLength": "30",
				"ExcludeSpecialChars": "false"
			},
			"task": {
				"id": "2fcdbd16-2baa-491d-9ed9-2923060a54be",
				"definitionType": "task",
				"versionSpec": "1.*"
			},
			"timeoutInMinutes": 0,
			"environment": {}
		}
	],
	"version": {
		"isTest": false,
		"major": 1,
		"minor": 0,
		"patch": 0
	}
}